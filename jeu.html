<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Mon 1er jeu Phaser</title>
        <script
            src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">
        </script>
        <style type="text/css"> 
            body { margin: 0; }
        </style>
    </head>


    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,
                width: 1000, height: 1000,
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 300 },
                    debug: false
                    }
                },

                scene: {preload: preload, create: create, update: update }
            };

            new Phaser.Game(config);

            function preload(){
                this.load.spritesheet('perso','assets/perso.png',
                { frameWidth: 32, frameHeight: 48 });
                this.load.image('fond', 'assets/background_2.png')
                this.load.image("Phaser_tileset", "assets/tilesetOrdonne.png");
                this.load.tilemapTiledJSON("carte", "assets/map.json");
            }

            var platforms;
            var player;
            var cursors;
            var gameOver;

            gameOver=false;

            function create(){


                //this.add.image(0, 0, 'fond'); 
                const carteNiveau = this.add.tilemap("carte");

                const tilset = carteNiveau.addTilesetImage(
                    "tileset",
                    "Phaser_tileset"
                );



                const calque_plateformes = carteDuNiveau.createLayer(
                    "plateformes",
                    tileset
                );

                const calque_deco = carteDuNiveau.createLayer(
                    "décos",
                    tileset
                );



                calque_plateformes.setCollisionbyProperty({ estSolide: true});
                
                


                player = this.physics.add.sprite(100, 450, 'perso');
                player.setBounce(0.2);
                player.setCollideWorldBounds(false);

                // redimentionnement du monde avec les dimensions calculées via tiled
                this.physics.world.setBounds(0, 0, 3200, 640);
                //  ajout du champs de la caméra de taille identique à celle du monde
                this.cameras.main.setBounds(0, 0, 3200, 640);
                // ancrage de la caméra sur le joueur
                this.cameras.main.startFollow(player); 


                this.physics.add.collider(player, platforms);


                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [ { key: 'perso', frame: 4 } ],
                    frameRate: 20
                });
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                    frameRate: 10,
                    repeat: -1
                });
                
                cursors = this.input.keyboard.createCursorKeys();


            }







            function update(){

                if (gameOver){return;}

                if (cursors.left.isDown){ //si la touche gauche est appuyée
                    player.setVelocityX(-160); //alors vitesse négative en X
                    player.anims.play('left', true); //et animation => gauche
                }
                else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
                    player.setVelocityX(160); //alors vitesse positive en X
                    player.anims.play('right', true); //et animation => droite

                }
                else{ // sinon
                    player.setVelocityX(0); //vitesse nulle
                    player.anims.play('turn'); //animation fait face caméra
                }
                if (cursors.up.isDown && player.body.touching.down){
                    //si touche haut appuyée ET que le perso touche le sol
                    player.setVelocityY(-330); //alors vitesse verticale négative
                    //(on saute)
                }

                if (cursors.down.isDown && !player.body.touching.down){ //si la touche bas est appuyée en saut
                    player.setVelocityY(450); 
                } 






            }









        </script>
    </body>
</html>