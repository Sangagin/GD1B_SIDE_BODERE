<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Mon 1er jeu Phaser</title>
        <script
            src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">
        </script>
        <link rel="stylesheet" href="cssJeuPlateforme.css">
        <style type="text/css"> 
            body { margin: 0; }
        </style>
    </head>


    <body>



       

        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,
                width: 600, height: 400,
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 300 },
                    debug: false
                    }
                },
                input:{gamepad:true},

                scene: {preload: preload, create: create, update: update }

               

            };

            game = new Phaser.Game(config);

            function preload(){
                this.load.spritesheet('perso','assets/perso.png',
                { frameWidth: 32, frameHeight: 48 });
                this.load.image('fond', 'assets/background_2.png')
                this.load.image("Phaser_tileset", "assets/tilesetOrdonne.png");
                this.load.tilemapTiledJSON("carte", "assets/map.json");





            }





            const seconds = new Date().getTime();
            var cursors;
            var gameOver;
            var counter =0;

            gameOver=false;
            this.sens=1;
            wallJump =true;

            function create(){

                
                background=this.add.image(800, 800, 'fond'); 
                const carteDuNiveau = this.add.tilemap("carte");

                const tileset = carteDuNiveau.addTilesetImage(
                    "tileset",
                    "Phaser_tileset"
                );



                const calque_plateformes = carteDuNiveau.createLayer(
                    "plateformes",
                    tileset
                );

                const calque_deco = carteDuNiveau.createLayer(
                    "décos",
                    tileset
                );



                calque_plateformes.setCollisionByProperty({EstSolide: true});

                




     










               // test.setScrollFactor(0)
                //ça fonctionne, a rajouter image de barre de vie

                this.player = this.physics.add.sprite(400, 770, 'perso');
                this.player.setBounce(0.2);
                this.player.setCollideWorldBounds(false);
                this.player.test=false;
               

                this.physics.add.collider(this.player, calque_plateformes); 


                // redimentionnement du monde avec les dimensions calculées via tiled
                this.physics.world.setBounds(0, 0, 1600, 1600);
                //  ajout du champs de la caméra de taille identique à celle du monde
                this.cameras.main.setBounds(0, 0, 1600, 1600);
                // ancrage de la caméra sur le joueur
                this.cameras.main.startFollow(this.player); 


                this.onWallDroit=false;
                this.onWallGauche=false;
                this.canJump = true;

                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [ { key: 'perso', frame: 4 } ],
                    frameRate: 20
                });
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                    frameRate: 10,
                    repeat: -1
                });
                
                cursors = this.input.keyboard.createCursorKeys();

                
            }





walljump =false;

            function update(){







                if (gameOver){return;}

                if (cursors.left.isDown && !this.onWallGauche && !walljump){ //si la touche gauche est appuyée

                        
                    this.player.setVelocityX(-160); //alors vitesse négative en X
                    this.player.anims.play('left', true); //et animation => gauche
                    //test.setActive(false).setVisible(false);
                    //fonctionne aussi, a utiliser pour les power ups
                }

                else if (this.onWallGauche && cursors.up.isDown){
                    walljump=true;
                    this.player.setVelocityY(-170);
                    this.player.setVelocityX(100); //alors vitesse positive en X
                    this.player.anims.play('right', true);
                    this.onWallGauche=false;
                    setTimeout(() => {
                        walljump=false;
                    }, 300);


                }
                
                else if (cursors.right.isDown && !this.onWallGauche && !walljump){ //sinon si la touche droite est appuyée
                    this.player.setVelocityX(160); //alors vitesse positive en X
                    this.player.anims.play('right', true); //et animation => droite
                }


                else if (this.onWallDroit && cursors.up.isDown){
                    walljump=true;
                    this.player.setVelocityY(-170);
                    this.player.setVelocityX(-100); //alors vitesse positive en X
                    this.player.anims.play('left', true);
                    this.onWallDroit=false;
                    setTimeout(() => {
                        walljump=false;
                    }, 300);


                }

                else if (!walljump){ // sinon
                    this.player.setVelocityX(0); //vitesse nulle
                    this.player.anims.play('turn'); //animation fait face caméra
                }





                if (cursors.up.isDown && this.player.body.blocked.down){
                    //si touche haut appuyée ET que le perso touche le sol
                    this.player.setVelocityY(-170); //alors vitesse verticale négative




                    // hero can't jump anymore
                    this.canJump = false;

                    // hero is not on the wall anymore
                    this.onWallDroit = false;
                    this.onWallGauche = false;




                }

                if (cursors.down.isDown && !this.player.body.touching.down){ //si la touche bas est appuyée en saut
                    this.player.setVelocityY(450); 
                } 

                if(this.player.body.blocked.down){
 
                    // hero can jump
                    this.canJump = true;

                    // hero not on the wall
                    this.onWallDroit = false;
                    this.onWallGauche = false;
                }



                if(this.player.body.blocked.right && !this.player.body.blocked.down){

                    this.onWallDroit = true;
                }



                if(this.player.body.blocked.left && !this.player.body.blocked.down){
                    this.onWallGauche = true;
                    
                }


            }
















        </script>
        <div id="myProgress">
            <div id="myBar" style="color:blue;text-align:center;" ></div>
        </div>

    </body>
</html>