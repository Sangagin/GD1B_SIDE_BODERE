<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Mon 1er jeu Phaser</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">
    </script>
    <link rel="stylesheet">
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>


<body>





    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 600, height: 4000,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: false
                }
            },
            input: { gamepad: true },

            scene: { preload: preload, create: create, update: update }



        };

        game = new Phaser.Game(config);

        function preload() {
            this.load.spritesheet('perso', 'assets/perso.png',
                { frameWidth: 32, frameHeight: 48 });
            this.load.image('fond', 'assets/background_2.png')
            this.load.image("Phaser_tileset", "assets/tilesetOrdonne.png");
            this.load.image("text1", "assets/fenetreTest.png");
            this.load.image("pics1", "assets/pics1.png");
            this.load.image("pics1_bas", "assets/pics1_bas.png");
            this.load.image("pics1_droite", "assets/pics1_droite.png");
            this.load.image("pics1_gauche", "assets/pics1_gauche.png");
            this.load.image("pics2", "assets/pics2.png");
            this.load.image("pics2_bas", "assets/pics2_bas.png");
            this.load.image("pics2_droite", "assets/pics2_droite.png");
            this.load.image("pics2_gauche", "assets/pics2_gauche.png");
            this.load.image("pics3", "assets/pics3.png");
            this.load.image("pics3_bas", "assets/pics3_bas.png");
            this.load.image("pics3_droite", "assets/pics3_droite.png");
            this.load.image("pics3_gauche", "assets/pics3_gauche.png");
            this.load.image("ui", "assets/UI.png");
            this.load.tilemapTiledJSON("carte", "assets/map.json");





        }





        var cursors;
        var gameOver;
        var counter = 0;
        gameOver = false;
        this.sens = 1;
        wallJump = true;
        vieModifiee = false; //sert a rajouter des frames d'invincibilité et d'actualiser la barre de vie



        function create() {


            background = this.add.image(800, 800, 'fond');
            const carteDuNiveau = this.add.tilemap("carte");

            const tileset = carteDuNiveau.addTilesetImage(
                "tileset",
                "Phaser_tileset"
            );



            const calque_plateformes = carteDuNiveau.createLayer(
                "plateformes",
                tileset
            );

            const calque_pics1 = carteDuNiveau.createLayer(
                "pic1",
                tileset
            );

            const calque_pics2 = carteDuNiveau.createLayer(
                "pic2",
                tileset
            );

            const calque_pics3 = carteDuNiveau.createLayer(
                "pic3",
                tileset
            );

            const calque_deco = carteDuNiveau.createLayer(
                "décos",
                tileset
            );



            calque_plateformes.setCollisionByProperty({ EstSolide: true });












            // 
            //ça fonctionne, a rajouter image de barre de vie

            this.player = this.physics.add.sprite(400, 770, 'perso');
            this.player.setBounce(0.2);
            this.player.setCollideWorldBounds(true);
            this.physics.add.collider(this.player, calque_plateformes);



            //test boite de message
            texte = this.add.image(this.player.x, this.player.y, 'text1')
            texte.visible = false;

            ui = this.add.image(this.player.x-124, this.player.y, 'ui')
            ui.setScrollFactor(0)

            //affichage des pics de niveau 1
            {
                this.spike1_1 = this.physics.add.sprite(592, 1264, 'pics1');
                this.spike1_2 = this.physics.add.sprite(464, 1520, 'pics1');
                this.spike1_3 = this.physics.add.sprite(496, 1520, 'pics1');
                this.spike1_4 = this.physics.add.sprite(176, 1264, 'pics1');
                this.spike1_5 = this.physics.add.sprite(144, 1264, 'pics1');
                this.spike1_6 = this.physics.add.sprite(1136, 1520 - 64, 'pics1');
                this.spike1_7 = this.physics.add.sprite(1136 + 32, 1520 - 64, 'pics1');
                this.spike1_8 = this.physics.add.sprite(1424, 1520 - 64, 'pics1');
                this.spike1_9 = this.physics.add.sprite(1424 + 96, 912, 'pics1');
                this.spike1_10 = this.physics.add.sprite(1424 - 32, 658, 'pics1');
                this.spike1_11 = this.physics.add.sprite(176 + 64, 1264 + 64, 'pics1_bas');
                this.spike1_12 = this.physics.add.sprite(176 + 96, 1264 + 64, 'pics1_bas');
                this.spike1_13 = this.physics.add.sprite(176 + 64, 975, 'pics1_bas');
                this.spike1_14 = this.physics.add.sprite(1136 - 32, 1264 + 64, 'pics1_bas');
                this.spike1_15 = this.physics.add.sprite(1136 - 64, 1264 + 64, 'pics1_bas');
                this.spike1_16 = this.physics.add.sprite(1424 + 96, 976 + 32, 'pics1_bas');
                this.spike1_17 = this.physics.add.sprite(1424 + 64, 976 + 32, 'pics1_bas');
                this.spike1_18 = this.physics.add.sprite(1424 + 96, 976 - 96 - 64, 'pics1_bas');
                this.spike1_19 = this.physics.add.sprite(1424 + 64, 976 - 96 - 64, 'pics1_bas');
                this.spike1_20 = this.physics.add.sprite(1424 + 32, 976 - 96 - 64, 'pics1_bas');
                this.spike1_21 = this.physics.add.sprite(1424 + 64, 1520 - 128, 'pics1_gauche');
                this.spike1_22 = this.physics.add.sprite(1424 + 64, 1520 - 128 - 32, 'pics1_gauche');
                this.spike1_23 = this.physics.add.sprite(1424 + 64, 1520 - 128 - 64, 'pics1_gauche');
                this.spike1_24 = this.physics.add.sprite(1424 + 64, 1520 - 128 - 96, 'pics1_gauche');

                this.spike1_1.body.allowGravity = false;
                this.spike1_2.body.allowGravity = false;
                this.spike1_3.body.allowGravity = false;
                this.spike1_4.body.allowGravity = false;
                this.spike1_5.body.allowGravity = false;
                this.spike1_6.body.allowGravity = false;
                this.spike1_7.body.allowGravity = false;
                this.spike1_8.body.allowGravity = false;
                this.spike1_9.body.allowGravity = false;
                this.spike1_10.body.allowGravity = false;
                this.spike1_11.body.allowGravity = false;
                this.spike1_12.body.allowGravity = false;
                this.spike1_13.body.allowGravity = false;
                this.spike1_14.body.allowGravity = false;
                this.spike1_15.body.allowGravity = false;
                this.spike1_16.body.allowGravity = false;
                this.spike1_17.body.allowGravity = false;
                this.spike1_18.body.allowGravity = false;
                this.spike1_19.body.allowGravity = false;
                this.spike1_20.body.allowGravity = false;
                this.spike1_21.body.allowGravity = false;
                this.spike1_22.body.allowGravity = false;
                this.spike1_23.body.allowGravity = false;
                this.spike1_24.body.allowGravity = false;

                this.spike1_1.body.immovable = true;
                this.spike1_2.body.immovable = true;
                this.spike1_3.body.immovable = true;
                this.spike1_4.body.immovable = true;
                this.spike1_5.body.immovable = true;
                this.spike1_6.body.immovable = true;
                this.spike1_7.body.immovable = true;
                this.spike1_8.body.immovable = true;
                this.spike1_9.body.immovable = true;
                this.spike1_10.body.immovable = true;
                this.spike1_11.body.immovable = true;
                this.spike1_12.body.immovable = true;
                this.spike1_13.body.immovable = true;
                this.spike1_14.body.immovable = true;
                this.spike1_15.body.immovable = true;
                this.spike1_16.body.immovable = true;
                this.spike1_17.body.immovable = true;
                this.spike1_18.body.immovable = true;
                this.spike1_19.body.immovable = true;
                this.spike1_20.body.immovable = true;
                this.spike1_21.body.immovable = true;
                this.spike1_22.body.immovable = true;
                this.spike1_23.body.immovable = true;
                this.spike1_24.body.immovable = true;


                this.physics.add.collider(this.player, this.spike1_1, playerHit1);
                this.physics.add.collider(this.player, this.spike1_2, playerHit1);
                this.physics.add.collider(this.player, this.spike1_3, playerHit1);
                this.physics.add.collider(this.player, this.spike1_4, playerHit1);
                this.physics.add.collider(this.player, this.spike1_5, playerHit1);
                this.physics.add.collider(this.player, this.spike1_6, playerHit1);
                this.physics.add.collider(this.player, this.spike1_7, playerHit1);
                this.physics.add.collider(this.player, this.spike1_8, playerHit1);
                this.physics.add.collider(this.player, this.spike1_9, playerHit1);
                this.physics.add.collider(this.player, this.spike1_10, playerHit1);
                this.physics.add.collider(this.player, this.spike1_11, playerHit1);
                this.physics.add.collider(this.player, this.spike1_12, playerHit1);
                this.physics.add.collider(this.player, this.spike1_13, playerHit1);
                this.physics.add.collider(this.player, this.spike1_14, playerHit1);
                this.physics.add.collider(this.player, this.spike1_15, playerHit1);
                this.physics.add.collider(this.player, this.spike1_16, playerHit1);
                this.physics.add.collider(this.player, this.spike1_17, playerHit1);
                this.physics.add.collider(this.player, this.spike1_18, playerHit1);
                this.physics.add.collider(this.player, this.spike1_19, playerHit1);
                this.physics.add.collider(this.player, this.spike1_20, playerHit1);
                this.physics.add.collider(this.player, this.spike1_21, playerHit1);
                this.physics.add.collider(this.player, this.spike1_22, playerHit1);
                this.physics.add.collider(this.player, this.spike1_23, playerHit1);
                this.physics.add.collider(this.player, this.spike1_24, playerHit1);
            }
            //affichage des pics de niveau 2
            {

                this.spike2_1 = this.physics.add.sprite(1136 - 96, 208, 'pics2');
                this.spike2_2 = this.physics.add.sprite(592, 208 + 128, 'pics2');
                this.spike2_3 = this.physics.add.sprite(592 + 32, 208 + 128, 'pics2');
                this.spike2_4 = this.physics.add.sprite(592 - 320 + 64, 208 + 64, 'pics2');
                this.spike2_5 = this.physics.add.sprite(592 - 320 + 64 + 64, 208 + 64, 'pics2_gauche');
                this.spike2_6 = this.physics.add.sprite(592 + 96, 208 - 32, 'pics2_gauche');
                this.spike2_7 = this.physics.add.sprite(592 + 96, 208 - 64, 'pics2_gauche');
                this.spike2_8 = this.physics.add.sprite(1136, 208 - 64 - 64, 'pics2_gauche');
                this.spike2_9 = this.physics.add.sprite(1136 - 32, 208 + 32, 'pics2_droite');
                this.spike2_10 = this.physics.add.sprite(1136 - 128 - 96, 208 + 32, 'pics2_droite');
                this.spike2_11 = this.physics.add.sprite(592, 208, 'pics2_droite');
                this.spike2_12 = this.physics.add.sprite(592, 208 - 32, 'pics2_droite');
                this.spike2_13 = this.physics.add.sprite(592, 208 - 64, 'pics2_droite');
                this.spike2_14 = this.physics.add.sprite(1136 + 96 + 32, 208 + 128 + 128 + 32, 'pics2_droite');
                this.spike2_15 = this.physics.add.sprite(1136 + 96 + 32, 208 + 128 + 128 + 32 + 32, 'pics2_droite');
                this.spike2_16 = this.physics.add.sprite(1136 + 96 + 32, 208 + 128 + 128 + 32 + 64, 'pics2_droite');


                this.spike2_1.body.allowGravity = false;
                this.spike2_2.body.allowGravity = false;
                this.spike2_3.body.allowGravity = false;
                this.spike2_4.body.allowGravity = false;
                this.spike2_5.body.allowGravity = false;
                this.spike2_6.body.allowGravity = false;
                this.spike2_7.body.allowGravity = false;
                this.spike2_8.body.allowGravity = false;
                this.spike2_9.body.allowGravity = false;
                this.spike2_10.body.allowGravity = false;
                this.spike2_11.body.allowGravity = false;
                this.spike2_12.body.allowGravity = false;
                this.spike2_13.body.allowGravity = false;
                this.spike2_14.body.allowGravity = false;
                this.spike2_15.body.allowGravity = false;
                this.spike2_16.body.allowGravity = false;

                this.spike2_1.body.immovable = true;
                this.spike2_2.body.immovable = true;
                this.spike2_3.body.immovable = true;
                this.spike2_4.body.immovable = true;
                this.spike2_5.body.immovable = true;
                this.spike2_6.body.immovable = true;
                this.spike2_7.body.immovable = true;
                this.spike2_8.body.immovable = true;
                this.spike2_9.body.immovable = true;
                this.spike2_10.body.immovable = true;
                this.spike2_11.body.immovable = true;
                this.spike2_12.body.immovable = true;
                this.spike2_13.body.immovable = true;
                this.spike2_14.body.immovable = true;
                this.spike2_15.body.immovable = true;
                this.spike2_16.body.immovable = true;


                this.physics.add.collider(this.player, this.spike2_1, playerHit1);
                this.physics.add.collider(this.player, this.spike2_2, playerHit1);
                this.physics.add.collider(this.player, this.spike2_3, playerHit1);
                this.physics.add.collider(this.player, this.spike2_4, playerHit1);
                this.physics.add.collider(this.player, this.spike2_5, playerHit1);
                this.physics.add.collider(this.player, this.spike2_6, playerHit1);
                this.physics.add.collider(this.player, this.spike2_7, playerHit1);
                this.physics.add.collider(this.player, this.spike2_8, playerHit1);
                this.physics.add.collider(this.player, this.spike2_9, playerHit1);
                this.physics.add.collider(this.player, this.spike2_10, playerHit1);
                this.physics.add.collider(this.player, this.spike2_11, playerHit1);
                this.physics.add.collider(this.player, this.spike2_12, playerHit1);
                this.physics.add.collider(this.player, this.spike2_13, playerHit1);
                this.physics.add.collider(this.player, this.spike2_14, playerHit1);
                this.physics.add.collider(this.player, this.spike2_15, playerHit1);
                this.physics.add.collider(this.player, this.spike2_16, playerHit1);



            }

            //affichage des pics de niveau 3

            {

                this.spike3_1 = this.physics.add.sprite(1136 - 96, 208 + 128 +64, 'pics3_bas');
                this.spike3_2 = this.physics.add.sprite(1136 - 96 -32, 208 + 128 +64, 'pics3_bas');
                this.spike3_3 = this.physics.add.sprite(1136 - 96 -32-32, 208 + 128 +64, 'pics3_bas');
                this.spike3_4 = this.physics.add.sprite(816, 208 + 128 +96, 'pics3_bas');
                this.spike3_5 = this.physics.add.sprite(816 -32, 208 + 128 +96, 'pics3_bas');
                this.spike3_6 = this.physics.add.sprite(816-64, 208 + 128 +96, 'pics3_bas');                
                this.spike3_7 = this.physics.add.sprite(816-96, 208 + 128 +96, 'pics3_bas');
                this.spike3_8 = this.physics.add.sprite(816 -128, 208 + 128 +96, 'pics3_bas');
                this.spike3_9 = this.physics.add.sprite(816-160, 208 + 128 +96, 'pics3_bas');                
                this.spike3_10 = this.physics.add.sprite(816-192, 208 + 128 +96, 'pics3_bas');
                this.spike3_11 = this.physics.add.sprite(816 -192-32, 208 + 128 +96, 'pics3_bas');
                this.spike3_12 = this.physics.add.sprite(816-192-64, 208 + 128 +96, 'pics3_bas');
                this.spike3_13 = this.physics.add.sprite(812 -192-32-124-32, 208 + 128 +96, 'pics3_bas');
                this.spike3_14 = this.physics.add.sprite(812-192-64-124-32, 208 + 128 +96, 'pics3_bas');

                this.spike3_1.body.allowGravity = false;
                this.spike3_2.body.allowGravity = false;
                this.spike3_3.body.allowGravity = false;
                this.spike3_4.body.allowGravity = false;
                this.spike3_5.body.allowGravity = false;
                this.spike3_6.body.allowGravity = false;
                this.spike3_7.body.allowGravity = false;
                this.spike3_8.body.allowGravity = false;
                this.spike3_9.body.allowGravity = false;
                this.spike3_10.body.allowGravity = false;
                this.spike3_11.body.allowGravity = false;
                this.spike3_12.body.allowGravity = false;
                this.spike3_13.body.allowGravity = false;
                this.spike3_14.body.allowGravity = false;

                this.spike3_1.body.immovable = true;
                this.spike3_2.body.immovable = true;
                this.spike3_3.body.immovable = true;
                this.spike3_4.body.immovable = true;
                this.spike3_5.body.immovable = true;
                this.spike3_6.body.immovable = true;
                this.spike3_7.body.immovable = true;
                this.spike3_8.body.immovable = true;
                this.spike3_9.body.immovable = true;
                this.spike3_10.body.immovable = true;
                this.spike3_11.body.immovable = true;
                this.spike3_12.body.immovable = true;
                this.spike3_13.body.immovable = true;
                this.spike3_14.body.immovable = true;

                this.physics.add.collider(this.player, this.spike3_1, playerHit1);
                this.physics.add.collider(this.player, this.spike3_2, playerHit1);
                this.physics.add.collider(this.player, this.spike3_3, playerHit1);
                this.physics.add.collider(this.player, this.spike3_4, playerHit1);
                this.physics.add.collider(this.player, this.spike3_5, playerHit1);
                this.physics.add.collider(this.player, this.spike3_6, playerHit1);
                this.physics.add.collider(this.player, this.spike3_7, playerHit1);
                this.physics.add.collider(this.player, this.spike3_8, playerHit1);
                this.physics.add.collider(this.player, this.spike3_9, playerHit1);
                this.physics.add.collider(this.player, this.spike3_10, playerHit1);
                this.physics.add.collider(this.player, this.spike3_11, playerHit1);
                this.physics.add.collider(this.player, this.spike3_12, playerHit1);
                this.physics.add.collider(this.player, this.spike3_13, playerHit1);
                this.physics.add.collider(this.player, this.spike3_14, playerHit1);
            }

            //manque les pics de coté
            
            //affichage de l'ennemi mobile


            //affichage des pièces














            // redimentionnement du monde avec les dimensions calculées via tiled
            this.physics.world.setBounds(0, 0, 1600, 1600);
            //  ajout du champs de la caméra de taille identique à celle du monde
            this.cameras.main.setBounds(0, 0, 1600, 1600);
            // ancrage de la caméra sur le joueur
            this.cameras.main.startFollow(this.player);


            this.onWallDroit = false;
            this.onWallGauche = false;
            this.canJump = true;

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('perso', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });
            this.anims.create({
                key: 'turn',
                frames: [{ key: 'perso', frame: 4 }],
                frameRate: 20
            });
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('perso', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });

            cursors = this.input.keyboard.createCursorKeys();


        }





        walljump = false;

        function update() {



            


            if (gameOver) { return; }

            if (cursors.left.isDown && !this.onWallGauche && !walljump) { //si la touche gauche est appuyée


                this.player.setVelocityX(-160); //alors vitesse négative en X
                this.player.anims.play('left', true); //et animation => gauche
                //test.setActive(false).setVisible(false);
                //fonctionne aussi, a utiliser pour les power ups
            }

            else if (this.onWallGauche && cursors.up.isDown) {
                walljump = true;
                this.player.setVelocityY(-170);
                this.player.setVelocityX(100); //alors vitesse positive en X
                this.player.anims.play('right', true);
                this.onWallGauche = false;
                setTimeout(() => {
                    walljump = false;
                }, 300);


            }

            else if (cursors.right.isDown && !this.onWallDroit && !walljump) { //sinon si la touche droite est appuyée
                this.player.setVelocityX(160); //alors vitesse positive en X
                this.player.anims.play('right', true); //et animation => droite
            }


            else if (this.onWallDroit && cursors.up.isDown) {
                walljump = true;
                this.player.setVelocityY(-170);
                this.player.setVelocityX(-100); //alors vitesse positive en X
                this.player.anims.play('left', true);
                this.onWallDroit = false;
                setTimeout(() => {
                    walljump = false;
                }, 300);


            }

            else if (!walljump) { // sinon
                this.player.setVelocityX(0); //vitesse nulle
                this.player.anims.play('turn'); //animation fait face caméra
            }
            setTimeout(() => {
                this.onWall = false;

            }, 3000);


            //lien anim https://stackabuse.com/phaser-3-and-tiled-building-a-platformer/


            if (cursors.up.isDown && this.player.body.blocked.down) {
                //si touche haut appuyée ET que le perso touche le sol
                this.player.setVelocityY(-170); //alors vitesse verticale négative




                // hero can't jump anymore
                this.canJump = false;

                // hero is not on the wall anymore
                this.onWallDroit = false;
                this.onWallGauche = false;




            }

            if (cursors.down.isDown && !this.player.body.touching.down) { //si la touche bas est appuyée en saut
                this.player.setVelocityY(450);
            }

            if (this.player.body.blocked.down) {

                // hero can jump
                this.canJump = true;

                // hero not on the wall
                this.onWallDroit = false;
                this.onWallGauche = false;
            }



            if (this.player.body.blocked.right && !this.player.body.blocked.down) {

                this.onWallDroit = true;
            }



            if (this.player.body.blocked.left && !this.player.body.blocked.down) {
                this.onWallGauche = true;

            }


        }



        function playerHit1() {
            console.log("touché violet !")


        }




















    </script>
    <div id="myProgress">
        <div id="myBar" style="color:blue;text-align:center;"></div>
    </div>

</body>

</html>